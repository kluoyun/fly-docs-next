---
sidebar_position: 9
---

# Возобновление печати после отключения питания в Klipper

## Обзор

- Возобновление печати после отключения питания в Klipper означает, что после восстановления питания система автоматически возобновляет состояние печати Klipper.
- Для работы этой функции необходимо использовать модуль безопасного выключения.
- Не подходит для моделей, где после отключения питания Z-ось смещается.

## Настройка

### Конфигурационный файл plr.cfg

- В разделе конфигурации принтера нажмите "Создать новый конфигурационный файл" и создайте файл `plr.cfg`.
- Содержимое файла должно быть следующим:

    ```cfg
    [mcu host]   
    serial: /tmp/klipper_host_mcu
    
    [power_loss_resume]
    # power_pin: PA0 # вывод отключения питания для модуля безопасного выключения, подключенный к выводу PA0 нижнего контроллера
    power_pin: host:gpiochip1/gpio20 # вывод отключения питания для модуля безопасного выключения, подключенный к выводу PA21 верхнего контроллера
    is_shutdown: True # Выполнять ли операцию выключения, по умолчанию включено
    paused_recover_z: -2.0 # При возобновлении печати из паузы перемещение по Z, по умолчанию не производится
    start_gcode:
        # G-code для выполнения перед возобновлением печати
        # Все параметры, сохраненные до выключения питания, доступны через {PLR}
        # Для вывода всех доступных параметров используйте M118 {PLR}
        M118 Начало возобновления: {PLR.print_stats.filename}
        M118 Точка прерывания: X:[{PLR.POS_X}] Y:[{PLR.POS_Y}] Z:[{PLR.POS_Z}] E:[{PLR.POS_E}]
        M140 S{PLR.bed.target}      ; Установка температуры нагревательной платформы
        M104 S{PLR.extruder.target-10}  ; Установка температуры сопла
        M109 S{PLR.extruder.target-10}  ; Ожидание нагрева сопла до заданной температуры
        G91                             ; Относительные координаты
        G1 Z2 F100                      ; Поднятие Z, подготовка к сбросу X,Y
        G90                             ; Абсолютные координаты
        G28 X Y                         ; Возврат к нулю X,Y
        M140 S{PLR.bed.target}          ; Установка температуры нагревательной платформы
        M104 S{PLR.extruder.target}     ; Установка температуры сопла
        M190 S{PLR.bed.target}          ; Ожидание достижения температуры нагревательной платформы
        M109 S{PLR.extruder.target}     ; Ожидание достижения температуры сопла
        M83                             ; Относительная экструзия
        # G1 E0.5 F400                  ; Экструзия немного материала
    layer_count: 2 # Количество слоев для продолжения печати перед выполнением layer_change_gcode
    layer_change_gcode:                
        # G-code для выполнения после возобновления печати {layer_count} слоев
        M118 Возобновление скорости печати
        M106 S{PLR.fan_speed}             ; Включение вентилятора экструдера
        M220 S{PLR.move_speed_percent}    ; Установка процентной скорости движения
        M221 S{PLR.extrude_speed_percent} ; Установка процентной скорости экструзии
    shutdown_gcode:
        # G-code для выполнения перед выключением
        M118 Низкое напряжение питания, выключение
        # M112 ; Чрезвычайная остановка

    ```

    :::warning Внимание

    - В вышеуказанном конфигурационном файле `start_gcode` может потребоваться настройка в зависимости от конкретной модели принтера.

    :::

- После сохранения вышеуказанного конфигурационного файла откройте файл `printer.cfg` и добавьте в начало файла следующее содержимое:

    ```cfg

    [include plr.cfg]

    ```

- Нажмите кнопку "Сохранить" в правом верхнем углу и перезапустите систему.
- Таким образом, функция возобновления печати после отключения питания в Klipper будет успешно настроена.

## Тестирование

- Начните печать любого файла и во время печати нажмите кнопку "Экстренная остановка", чтобы имитировать отключение питания.
- Затем нажмите "Перезагрузить прошивку" и дождитесь нормального соединения Klipper.
- Если появится всплывающее окно на веб-странице или в KlipperScreen, это означает, что функция возобновления печати работает корректно.
- Далее можно протестировать реальное отключение питания.
