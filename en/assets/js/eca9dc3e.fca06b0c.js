"use strict";(self.webpackChunkklipper_docs=self.webpackChunkklipper_docs||[]).push([["8427"],{47042:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>i,default:()=>h,contentTitle:()=>l,assets:()=>a,toc:()=>d,metadata:()=>t});var t=JSON.parse('{"id":"ProductDoc/ExtensionBoard/bd-sensor/kliper","title":"Install **BDsensor**","description":"Connect the sensor cable to the motherboard or CAN bus tool headboard.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/ProductDoc/ExtensionBoard/bd-sensor/kliper.mdx","sourceDirName":"ProductDoc/ExtensionBoard/bd-sensor","slug":"/ProductDoc/ExtensionBoard/bd-sensor/kliper","permalink":"/fly-docs-next/en/docs/ProductDoc/ExtensionBoard/bd-sensor/kliper","draft":false,"unlisted":false,"editUrl":"https://github.com/kluoyun/fly-docs-next/tree/master/docs/ProductDoc/ExtensionBoard/bd-sensor/kliper.mdx","tags":[],"version":"current","lastUpdatedBy":"Xiaok","lastUpdatedAt":1743130497000,"sidebarPosition":3,"frontMatter":{"sidebar_position":3,"sidebar_label":"klipper use"},"sidebar":"tutorialSidebar","previous":{"title":"Installation Guide","permalink":"/fly-docs-next/en/docs/ProductDoc/ExtensionBoard/bd-sensor/line"},"next":{"title":"Marlin Usage","permalink":"/fly-docs-next/en/docs/ProductDoc/ExtensionBoard/bd-sensor/marlin"}}'),o=s(85893),r=s(50065);let i={sidebar_position:3,sidebar_label:"klipper use"},l="Install BDsensor",a={},d=[{value:"Connect the sensor cable to the motherboard or CAN bus tool headboard.",id:"connect-the-sensor-cable-to-the-motherboard-or-can-bus-tool-headboard",level:2},{value:"Install the patch into the klipper firmware",id:"install-the-patch-into-the-klipper-firmware",level:2},{value:"If your printer is running Moonraker, add the following part to moonraker.conf, and then you can update BDsensor by clicking once through the web page or klipperscreen.",id:"if-your-printer-is-running-moonraker-add-the-following-part-to-moonrakerconf-and-then-you-can-update-bdsensor-by-clicking-once-through-the-web-page-or-klipperscreen",level:2},{value:"Edit printer.cfg",id:"edit-printercfg",level:2},{value:"After installation, check by sending the following gcode commands",id:"after-installation-check-by-sending-the-following-gcode-commands",level:2},{value:"Check the connection",id:"check-the-connection",level:2},{value:"Calibration",id:"calibration",level:2}];function c(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...e.components},{ImageView:t}=n;return t||function(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("ImageView",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsxs)(n.h1,{id:"install-bdsensor",children:["Install ",(0,o.jsx)(n.strong,{children:"BDsensor"})]})}),"\n",(0,o.jsx)(n.h2,{id:"connect-the-sensor-cable-to-the-motherboard-or-can-bus-tool-headboard",children:"Connect the sensor cable to the motherboard or CAN bus tool headboard."}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Please note that SB2040 cannot use BDsensor"}),"\n",(0,o.jsx)(n.li,{children:"Please note that SHT36 needs to connect BDsensor's CLK/SCL (Input) to the high voltage input port, and connect the jumper"}),"\n",(0,o.jsx)(n.li,{children:"BDsensor's CKL and SDA lines can be connected to any GPIO pin on the circuit board. You can also connect the BD sensor cable directly to the Bltouch port, for example:"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"BLtouch    |    BDsensor\n5V       --\x3e     5V\nGND      --\x3e     GND\nS        --\x3e     CLK/SCL    (Input)\nGND      --\x3e     GND\nZmin     --\x3e     SDA    (Input/Output) \n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Since some pins in the motherboard connector may not be directly connected to the MCU's gpios (for example, they may have filtering capacitors on them or be isolated by MOSFETs, diodes or optocouplers, but if they are isolated by resistors or resistor pull-up/pull-downs, they can be used), they cannot be used with BDsensor. And the firmware will report a connection error. For example"}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"The connectors for fans and heaters are isolated by MOSFETs,"}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"The connectors for temperature thermistors and endstops/probes in some circuit boards are usually connected to GND through filtering capacitors,"}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["As shown in the figure below, install the BD sensor near the hot end. ",(0,o.jsx)(n.a,{href:"https://www.thingiverse.com/thing:6098131",children:"STL of mount"}),",  ",(0,o.jsx)(n.a,{href:"https://discord.com/channels/829828765512106054/1163237892957671424",children:"STL_mount_VzBot_Goliath short"})]}),"\n",(0,o.jsx)(t,{image:s(82481).Z,size:"100%",align:"left"}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"install-the-patch-into-the-klipper-firmware",children:"Install the patch into the klipper firmware"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Discard the previously modified klipper files and update klipper"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"cd\ncd ~/klipper\ngit checkout .\ngit pull\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Clone the latest code of BDsensor"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"cd && git clone https://github.com/markniu/Bed_Distance_sensor.git\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Install"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"cd  ~/Bed_Distance_sensor/klipper/\n./install_BDsensor.sh\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Compile the firmware"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"cd ~/klipper/\nmake menuconfig\nmake clean\nmake\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Burn the firmware to the MCU or CANbus tool headboard connected to the BD sensor"}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"if-your-printer-is-running-moonraker-add-the-following-part-to-moonrakerconf-and-then-you-can-update-bdsensor-by-clicking-once-through-the-web-page-or-klipperscreen",children:"If your printer is running Moonraker, add the following part to moonraker.conf, and then you can update BDsensor by clicking once through the web page or klipperscreen."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"[update_manager BDsensor]\ntype: git_repo\nprimary_branch: new\nchannel: dev\npath: ~/Bed_Distance_sensor\norigin: https://github.com/markniu/Bed_Distance_sensor.git\ninstall_script: ./klipper/install_BDsensor.sh\nis_system_service: False\nmanaged_services: klipper\ninfo_tags:\ndesc=Bed Distance Sensor\n"})}),"\n",(0,o.jsx)(n.h2,{id:"edit-printercfg",children:"Edit printer.cfg"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Copy this part to your ",(0,o.jsx)(n.strong,{children:"printer.cfg"})," and edit ",(0,o.jsx)(n.code,{children:"[BDsensor]"})," ",(0,o.jsx)(n.code,{children:"sda_pin"}),"  ",(0,o.jsx)(n.code,{children:"scl_pin"}),", and don't forget to disable other probe parts, such as ",(0,o.jsx)(n.strong,{children:"BLtouch"}),". You can connect the BD sensor on the motherboard or tool head CAN module,"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Change ",(0,o.jsx)(n.code,{children:"speed"})," to 0.8 in ",(0,o.jsx)(n.code,{children:"[BDsensor]"}),". This is only applicable to z tilt and PROBE_ACCURACY commands. The smaller the value, the higher the accuracy during probing, because the MCU does not read the BD sensor in the main loop in real-time like a normal stopper when homing. ",(0,o.jsx)(n.code,{children:"[BDsensor]"})]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["To use the BD sensor as a limit switch when the Z axis homes, change ",(0,o.jsx)(n.code,{children:"endstop_pin"})," in ",(0,o.jsx)(n.code,{children:"[stepper_z]"})," to ",(0,o.jsx)(n.code,{children:"endstop_pin: probe:z_virtual_endstop"})]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Make sure there is ",(0,o.jsx)(n.code,{children:"[safe_z_home]"})," in ",(0,o.jsx)(n.strong,{children:"printer.cfg"})]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Change the value of ",(0,o.jsx)(n.code,{children:"[quad_gantry_level]"})," in ",(0,o.jsx)(n.code,{children:"[bed_mesh]"})," and ",(0,o.jsx)(n.code,{children:"[z_tilt]"})," or ",(0,o.jsx)(n.code,{children:"[quad_gantry_level]"})," to 1 (recommended 0.7-1.0mm). The default value in klipper is 5mm, otherwise it is easy to exceed the sensor range"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:(0,o.jsxs)(n.strong,{children:["Nozzle height is only suitable for setting in ",(0,o.jsx)(n.code,{children:"z_adjust:"}),", positive numbers are close to the hot bed, negative numbers are away from the hot bed, other settings for adjusting nozzle height will have bugs"]})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["To enable fast bed leveling, delete the # in front of ",(0,o.jsx)(n.code,{children:"no_stop_probe:true"})]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Below is a configuration example."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cfg",children:"[BDsensor] \nscl_pin:PC6  # Servo signal port\nsda_pin:PC3  # Limit signal port\ndelay: 20 # 20us per pulse, this value should be >=20 but must be below 50\nz_offset:0 # this `z_offset` must be set to 0. \nz_adjust:0.0 # z axis adjustment, replace the z_offset function. within -0.3 to 0.3mm\nx_offset: -34\ny_offset: 0\n#no_stop_probe:true # enable this for fast probe, the toolhead will not stop at the probe point.\nposition_endstop: 0.8 # the Z axis will stop at this position (mm) while homing z, recommend value is 0.4~1.0\n#speed:0.8 # this speed only works for the z tilt and PROBE_ACCURACY command.\n\n[stepper_z]\nendstop_pin: probe:z_virtual_endstop \n#position_endstop: 0.5\nhoming_speed: 5\nsecond_homing_speed: 0.8\n\n[bed_mesh]\nspeed: 200\nhorizontal_move_z:1\nalgorithm: bicubic\n\n[quad_gantry_level]\nhorizontal_move_z:1\n\n"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"after-installation-check-by-sending-the-following-gcode-commands",children:"After installation, check by sending the following gcode commands"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"M102   S-1     # Read sensor information\nM102   S-2     # Read a distance value\n"})}),"\n",(0,o.jsx)(n.h2,{id:"check-the-connection",children:"Check the connection"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Send ",(0,o.jsx)(n.code,{children:"M102 S-1"})," through the ",(0,o.jsx)(n.strong,{children:"console"}),". This is an example of the returned message. If a blank or other string is returned, please check the connection and wire order"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"Send: M102 S-1\nRecv: V1.0 pandapi3d.com\n"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"calibration",children:"Calibration"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Clean the nozzle, then move the Z axis through the console until the nozzle just touches the bed plate (BDsensor will use this position as the zero position, so there is no need for ",(0,o.jsx)(n.code,{children:"z_offset"}),", which is why the value in the [BDsensor] section is 0)"]}),"\n",(0,o.jsxs)(n.li,{children:["Send the gcode command ",(0,o.jsx)(n.code,{children:"M102 S-6"})," from the ",(0,o.jsx)(n.strong,{children:"console"}),", the printer will move the Z axis slowly upward by 0.1mm each time until it reaches 4mm. Do not run M102 S-6 before installing the sensor, nor turn off the printer power during calibration, otherwise the old calibration data will be deleted. If this happens, just calibrate again"]}),"\n",(0,o.jsxs)(n.li,{children:["Afterwards, you can check whether the BD sensor has been successfully calibrated through ",(0,o.jsx)(n.code,{children:"M102 S-5"}),", which will return the original calibration data stored in the BD sensor."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Notes"}),":"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"The homing speed of the Z axis is best at 5"}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"If the first raw calibration data returned by M102 S-5 is greater than 400, it means that the sensor is installed too high and needs to be reinstalled closer to the bed. The recommended value for the first data is 100. Also, make sure that the second data value is more than 10 greater than the first data"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"FAQ: What does it mean if the calibration data starts with 1, the second value is 9, and the third value is 24?"}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"This means that the resolution between 0-0.1mm is only 9, while the resolution between 0.1-0.2mm is 15. Therefore, it is recommended to recalibrate to make the first resolution 0-0.1mm greater than 10."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Please don't forget to adjust the Z axis height after running G28 or for these commands ",(0,o.jsx)(n.code,{children:"Z_tilt"})," and ",(0,o.jsx)(n.code,{children:"quad_gantry_level"})]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["The part names must be correctly capitalized and lowercased, otherwise klipper will report ",(0,o.jsx)(n.code,{children:"Unknown pin chip name 'probe'"})]}),"\n"]}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},82481:function(e,n,s){s.d(n,{Z:()=>t});let t=s.p+"assets/images/bd-4d1080107145fed7d8a6ac8c4e5d9536.webp"},50065:function(e,n,s){s.d(n,{Z:()=>l,a:()=>i});var t=s(67294);let o={},r=t.createContext(o);function i(e){let n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);