"use strict";(self.webpackChunkklipper_docs=self.webpackChunkklipper_docs||[]).push([["24721"],{82979:function(e,n,i){i.r(n),i.d(n,{metadata:()=>t,contentTitle:()=>a,default:()=>c,assets:()=>l,toc:()=>d,frontMatter:()=>r});var t=JSON.parse('{"id":"ProductDoc/ExtensionBoard/bd-sensor/marlin","title":"Installation **BDsensor**","description":"Connect the sensor cable to the motherboard or CAN bus toolhead board.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/ProductDoc/ExtensionBoard/bd-sensor/marlin.mdx","sourceDirName":"ProductDoc/ExtensionBoard/bd-sensor","slug":"/ProductDoc/ExtensionBoard/bd-sensor/marlin","permalink":"/fly-docs-next/en/docs/ProductDoc/ExtensionBoard/bd-sensor/marlin","draft":false,"unlisted":false,"editUrl":"https://github.com/kluoyun/fly-docs-next/tree/master/docs/ProductDoc/ExtensionBoard/bd-sensor/marlin.mdx","tags":[],"version":"current","lastUpdatedBy":"Xiaok","lastUpdatedAt":1732265789000,"sidebarPosition":3,"frontMatter":{"sidebar_position":3,"sidebar_label":"Using Marlin"},"sidebar":"tutorialSidebar","previous":{"title":"Using klipper","permalink":"/fly-docs-next/en/docs/ProductDoc/ExtensionBoard/bd-sensor/kliper"},"next":{"title":"Klipper Automatic Z-OFFSET","permalink":"/fly-docs-next/en/docs/ProductDoc/ExtensionBoard/bd-sensor/klipperpz"}}'),s=i("52676"),o=i("79938");let r={sidebar_position:3,sidebar_label:"Using Marlin"},a="Installation BDsensor",l={},d=[{value:"Connect the sensor cable to the motherboard or CAN bus toolhead board.",id:"connect-the-sensor-cable-to-the-motherboard-or-can-bus-toolhead-board",level:2},{value:"Install the patch into Marlin firmware",id:"install-the-patch-into-marlin-firmware",level:2},{value:"Edit Configuration.h",id:"edit-configurationh",level:3},{value:"Edit Configuration_adv.h",id:"edit-configuration_advh",level:3},{value:"Edit pins_boardname.h",id:"edit-pins_boardnameh",level:3},{value:"Display BD Sensor Values on LCD Screen",id:"display-bd-sensor-values-on-lcd-screen",level:2},{value:"Calibration",id:"calibration",level:2},{value:"Testing and Printing",id:"testing-and-printing",level:2},{value:"There are two ways to automatically level the bed:",id:"there-are-two-ways-to-automatically-level-the-bed",level:2},{value:"Check Z Endstop <code>M119</code>",id:"check-z-endstop-m119",level:3},{value:"Check Connection",id:"check-connection",level:3},{value:"If all the above steps are correct, you can now home the Z axis.",id:"if-all-the-above-steps-are-correct-you-can-now-home-the-z-axis",level:2}];function h(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components},{ImageView:t}=n;return!t&&function(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("ImageView",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsxs)(n.h1,{id:"installation-bdsensor",children:["Installation ",(0,s.jsx)(n.strong,{children:"BDsensor"})]})}),"\n",(0,s.jsx)(n.h2,{id:"connect-the-sensor-cable-to-the-motherboard-or-can-bus-toolhead-board",children:"Connect the sensor cable to the motherboard or CAN bus toolhead board."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Please note that SB2040 cannot use Bdsensor"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Please note that SHT36 needs to connect the Bdsensor's CLK/SCL (Input) to the high voltage input port and connect the jumper"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"The Bdsensor's CLK and SDA lines can be connected to any GPIO pin on the circuit board. You can also directly connect the BD sensor cable to the Bltouch port, for example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"BLtouch    |    BDsensor\n5V       --\x3e     5V\nGND      --\x3e     GND\nS        --\x3e     CLK/SCL    (Input)\nGND      --\x3e     GND\nZmin     --\x3e     SDA    (Input/Output) \n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Due to some pins in the motherboard connector may not be directly connected to the MCU's gpios (for example, they may have filter capacitors or are isolated through MOSFETs, diodes, or optocouplers, but if they are isolated through resistors or resistor pull-ups/downs), they cannot be used with Bdsensor. And the firmware will report a connection error. For example"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"The connectors for fans and heaters are isolated through MOSFETs,"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"In some boards, the connectors for temperature thermistors and endstops/probes are usually connected to GND through filter capacitors,"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["As shown below, install the BD sensor near the hot end. ",(0,s.jsx)(n.a,{href:"https://www.thingiverse.com/thing:6098131",children:"STL of mount"}),",  ",(0,s.jsx)(n.a,{href:"https://discord.com/channels/829828765512106054/1163237892957671424",children:"STL_mount_VzBot_Goliath short"})]}),"\n",(0,s.jsx)(t,{image:i(47663).Z,size:"100%",align:"left"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"install-the-patch-into-marlin-firmware",children:"Install the patch into Marlin firmware"}),"\n",(0,s.jsx)(n.p,{children:"BDsensor has been integrated into Marlin2.1.x (since August 27, 2022),"}),"\n",(0,s.jsxs)(n.p,{children:["You can download the release version. But now it is recommended to download the latest bugfix version: ",(0,s.jsx)(n.a,{href:"https://github.com/MarlinFirmware/Marlin",children:"https://github.com/MarlinFirmware/Marlin"})]}),"\n",(0,s.jsx)(n.p,{children:"What you need is to modify the configuration file and the pin file."}),"\n",(0,s.jsx)(n.h3,{id:"edit-configurationh",children:"Edit Configuration.h"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Enable BD_SENSOR"}),"\n",(0,s.jsx)(n.p,{children:"Uncomment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#define BD_SENSOR`\n`#define Z_SAFE_HOMING\n#define BD_SENSOR_PROBE_NO_STOP //adding this new line for fast bed leveling without nozzle stop, \n"})}),"\n",(0,s.jsxs)(n.p,{children:["Only ",(0,s.jsx)(n.code,{children:"BD_SENSOR_PROBE_NO_STOP"})]}),"\n",(0,s.jsxs)(n.p,{children:["Latest Marlin bugfix: ",(0,s.jsx)(n.a,{href:"https://github.com/MarlinFirmware/Marlin",children:"https://github.com/MarlinFirmware/Marlin"})]}),"\n",(0,s.jsxs)(n.p,{children:["Description: ",(0,s.jsx)(n.a,{href:"https://github.com/MarlinFirmware/Marlin/pull/25847",children:"https://github.com/MarlinFirmware/Marlin/pull/25847"})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Use the probe for homing"}),"\n",(0,s.jsxs)(n.p,{children:["Make sure ",(0,s.jsx)(n.code,{children:"Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN"})," is disabled, and enable ",(0,s.jsx)(n.code,{children:"USE_PROBE_FOR_Z_HOMING"})," as follows:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"//#define Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN\n// Force the use of the probe for Z-axis homing\n#define USE_PROBE_FOR_Z_HOMING\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Slow down the second homing Z speed"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#define Z_PROBE_FEEDRATE_SLOW (Z_PROBE_FEEDRATE_FAST / 16)\n"})}),"\n",(0,s.jsx)(n.p,{children:"Here, we must slow down the bump homing speed and Z homing speed because the stopper read from the BDsensor process is not real-time like normal stoppers."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"edit-configuration_advh",children:"Edit Configuration_adv.h"}),"\n",(0,s.jsxs)(n.p,{children:["Enable this feature ",(0,s.jsx)(n.code,{children:"#define BABYSTEPPING"})," to enable real-time leveling function"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#define HOMING_BUMP_DIVISOR { 2, 2, 8 }       // Re-Bump Speed Divisor (Divides the Homing Feedrate)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"edit-pins_boardnameh",children:"Edit pins_boardname.h"}),"\n",(0,s.jsxs)(n.p,{children:["By adding the following 3 lines in the pin file pins_boardname.h, configure the SDA and SCL pins for BDsensor (for example): ",(0,s.jsx)(n.code,{children:"pins_PANDA_PI_V29.h"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#define  I2C_BD_SDA_PIN    PC6   // Please change to the actual number which the SDA wire is connected to your mainboard\n#define  I2C_BD_SCL_PIN    PB2   // Please change to the actual number which the SLK wire is connected to your mainboard\n#define  I2C_BD_DELAY  20      // default value is 20, should be in the range [20,50].\n"})}),"\n",(0,s.jsx)(n.p,{children:"If you want to perform automatic bed leveling probe before printing (G29) like a normal BLtouch, uncomment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#define AUTO_BED_LEVELING_BILINEAR\n"})}),"\n",(0,s.jsx)(n.p,{children:"And edit the values as follows"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#define Z_CLEARANCE_DEPLOY_PROBE   0 // Z Clearance for Deploy/Stow\n#define Z_CLEARANCE_BETWEEN_PROBES  1 // Z Clearance between probe points\n#define Z_CLEARANCE_MULTI_PROBE     1 // Z Clearance between multiple probes\n"})}),"\n",(0,s.jsx)(n.h2,{id:"display-bd-sensor-values-on-lcd-screen",children:"Display BD Sensor Values on LCD Screen"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"For printers with status display (support gcode M117), such as LCD12864 or some uart screens, such as ender3V2 ..."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"calibration",children:"Calibration"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Clean the nozzle, then move the Z-axis via console until the nozzle just touches the bed (BDsensor will use this position as zero point, so no z_offset, set the value to 0)."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Send gcode command ",(0,s.jsx)(n.code,{children:"M102 S-6"}),", the printer will slowly move the Z-axis up by 0.1mm each time until it reaches 4mm. Do not run M102 S-6 before installing the sensor, and do not turn off the power during calibration, otherwise the old calibration data will be deleted. If this happens, just recalibrate."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["You can send ",(0,s.jsx)(n.code,{children:"M102 S-5"})," to check if the BD sensor is calibrated successfully, which will return the original calibration data stored in the BD sensor."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["There is also a calibration tool that can do this: ",(0,s.jsx)(n.a,{href:"https://github.com/markniu/Bed_Distance_sensor/raw/new/marlin/BD_Config_Tool_Marlin.zip",children:"https://github.com/markniu/Bed_Distance_sensor/raw/new/marlin/BD_Config_Tool_Marlin.zip"})," ",(0,s.jsx)(n.img,{src:"https://raw.githubusercontent.com/markniu/Bed_Distance_sensor/main/doc/images/Read.jpg",alt:"img"})]}),"\n",(0,s.jsx)(n.p,{children:"Note: Data value 1015 or > 1010 indicates out of sensor range. If the first five points (0~0.5mm) or more values are within 0 to 1000 range and the increased value delta is >=10, then calibration is successful. Just like the chart shown above."}),"\n",(0,s.jsx)(n.p,{children:"If the first original calibration data returned by M102 S-5 is greater than 400, it means the sensor is installed too high and needs to be reinstalled closer to the bed. Also ensure the second data value is more than 10 higher than the first value."}),"\n",(0,s.jsx)(n.h2,{id:"testing-and-printing",children:"Testing and Printing"}),"\n",(0,s.jsx)(n.p,{children:"Menu Bed Level"}),"\n",(0,s.jsx)(n.p,{children:"Automatic Bed Leveling"}),"\n",(0,s.jsx)(n.h2,{id:"there-are-two-ways-to-automatically-level-the-bed",children:"There are two ways to automatically level the bed:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"1. Use M102 to level the first few layers in real time"})}),"\n",(0,s.jsx)(n.p,{children:"We can easily enable or disable this automatic leveling by sending gcode commands or adding gcode in the gcode file."}),"\n",(0,s.jsxs)(n.p,{children:['To enable bed leveling in Klipper, add the M28 G code below the "Startup G Code" section in the printer machine settings. For example, below G28, this means it will only perform bed leveling at Z-axis heights below 0.2mm. ',(0,s.jsx)(n.code,{children:"M102 S2"})]}),"\n",(0,s.jsxs)(n.p,{children:["Send or use BD sensor to disable bed leveling, by the way, it is disabled by default. ",(0,s.jsx)(n.code,{children:"M102 S0``G28``M18"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"M102   S-1     //Read sensor information, and we can use this for connection checking.\nM102   S-2     //Read current distance value\nM102   S-5     //Read raw Calibrate data\nM102   S-6     //Start Calibrate,before that make sure the nozzle is just touched the bed, and then the printer restarted. Don't home z axis before this.\nM102   S4      //Set the adjustable Z height value, e.g. M102 S4  means it will do adjusting while the Z height <=0.4mm , disable it by M102 S0.\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"2. Auto-level the bed using G29"})}),"\n",(0,s.jsx)(n.p,{children:"Another way to auto-level the bed is like G29 for BLtouch, just add one line below G29."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://www.pandapi3d.com/post/install-bed-distance-sensor-video",children:"Installation video"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://youtu.be/VLUfvkO2NFc?si=PF_6nhw39KhHBhcj",children:"Installation video by Chris Basement"})}),"\n",(0,s.jsxs)(n.h3,{id:"check-z-endstop-m119",children:["Check Z Endstop ",(0,s.jsx)(n.code,{children:"M119"})]}),"\n",(0,s.jsx)(n.p,{children:"Before checking this step, do not home Z, otherwise the nozzle may crash into the print bed."}),"\n",(0,s.jsx)(n.p,{children:"This is the return message after sending the M119 command (report endstop status)."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"Send: M119\nRecv: x:open y:open z:open\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If z min is not open, check your configuration. ",(0,s.jsx)(n.code,{children:"#define Z_MAX_ENDSTOP_HIT_STATE HIGH"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Ensure the Z motor is off/unlocked"}),"\n",(0,s.jsx)(n.li,{children:"Manually move the Z-axis down until the nozzle closes the bed"}),"\n",(0,s.jsxs)(n.li,{children:["Send ",(0,s.jsx)(n.code,{children:"M102 S-2"}),", the return value should be 0.00mm, then send M119 again, you can see the z endstop is now triggered."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"Send: M119\nRecv: x:open y:open z:TRIGGERED\n"})}),"\n",(0,s.jsx)(n.h3,{id:"check-connection",children:"Check Connection"}),"\n",(0,s.jsxs)(n.p,{children:["Check the connection through ",(0,s.jsx)(n.code,{children:"M102 S-1"}),". This is an example of the return message, please check if the connection and wire order return blank or other strings."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"Send: M102 S-1\nRecv: V1.0 pandapi3d.com\n"})}),"\n",(0,s.jsx)(n.h2,{id:"if-all-the-above-steps-are-correct-you-can-now-home-the-z-axis",children:"If all the above steps are correct, you can now home the Z axis."})]})}function c(e={}){let{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},47663:function(e,n,i){i.d(n,{Z:function(){return t}});let t=i.p+"assets/images/bd-4d1080107145fed7d8a6ac8c4e5d9536.webp"},79938:function(e,n,i){i.d(n,{Z:function(){return a},a:function(){return r}});var t=i(75271);let s={},o=t.createContext(s);function r(e){let n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);