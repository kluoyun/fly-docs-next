"use strict";(self.webpackChunkklipper_docs=self.webpackChunkklipper_docs||[]).push([["4884"],{61500:function(e,n,t){t.r(n),t.d(n,{default:()=>h,frontMatter:()=>o,metadata:()=>s,assets:()=>a,toc:()=>c,contentTitle:()=>l});var s=JSON.parse('{"id":"ProductDoc/ExtensionBoard/BDsensor-m/kliper","title":"Install **BDsensor-m**","description":"Connect the sensor cable to the motherboard\'s EXP1 interface","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/ProductDoc/ExtensionBoard/BDsensor-m/kliper.mdx","sourceDirName":"ProductDoc/ExtensionBoard/BDsensor-m","slug":"/ProductDoc/ExtensionBoard/BDsensor-m/kliper","permalink":"/fly-docs-next/en/docs/ProductDoc/ExtensionBoard/BDsensor-m/kliper","draft":false,"unlisted":false,"editUrl":"https://github.com/kluoyun/fly-docs-next/tree/master/docs/ProductDoc/ExtensionBoard/BDsensor-m/kliper.mdx","tags":[],"version":"current","lastUpdatedBy":"Xiaok","lastUpdatedAt":1743130497000,"sidebarPosition":3,"frontMatter":{"sidebar_position":3,"sidebar_label":"klipper usage"},"sidebar":"tutorialSidebar","previous":{"title":"Installation Guide","permalink":"/fly-docs-next/en/docs/ProductDoc/ExtensionBoard/BDsensor-m/line"},"next":{"title":"Marlin Usage","permalink":"/fly-docs-next/en/docs/ProductDoc/ExtensionBoard/BDsensor-m/marlin"}}'),r=t("85893"),i=t("50065");let o={sidebar_position:3,sidebar_label:"klipper usage"},l="Install BDsensor-m",a={},c=[{value:"Connect the sensor cable to the motherboard&#39;s EXP1 interface",id:"connect-the-sensor-cable-to-the-motherboards-exp1-interface",level:2},{value:"Install the patch to the klipper firmware",id:"install-the-patch-to-the-klipper-firmware",level:2},{value:"Compile firmware here <code>if prompted that the firmware of the upper and lower computers is inconsistent</code>, compile a new klipper firmware",id:"compile-firmware-here-if-prompted-that-the-firmware-of-the-upper-and-lower-computers-is-inconsistent-compile-a-new-klipper-firmware",level:3},{value:"If your printer is running Moonraker, add the following part to moonraker.conf, and then you can update BDsensor by clicking once through the web page or klipperscreen.",id:"if-your-printer-is-running-moonraker-add-the-following-part-to-moonrakerconf-and-then-you-can-update-bdsensor-by-clicking-once-through-the-web-page-or-klipperscreen",level:2},{value:"Edit printer.cfg",id:"edit-printercfg",level:2},{value:"After installation, check by sending the following gcode commands",id:"after-installation-check-by-sending-the-following-gcode-commands",level:2},{value:"Check connection",id:"check-connection",level:2},{value:"Calibration",id:"calibration",level:2}];function d(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components},{ImageView:s}=n;return s||function(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("ImageView",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsxs)(n.h1,{id:"install-bdsensor-m",children:["Install ",(0,r.jsx)(n.strong,{children:"BDsensor-m"})]})}),"\n",(0,r.jsx)(n.h2,{id:"connect-the-sensor-cable-to-the-motherboards-exp1-interface",children:"Connect the sensor cable to the motherboard's EXP1 interface"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"If the sensor's cable is not long enough, you can use the delay line in the packaging."}),"\n",(0,r.jsx)(n.li,{children:"The CKL and SDA wires of the BDsensor-m can be connected to any GPIO pin on the circuit board. You can also connect the BD sensor cable directly to the Bltouch port, for example:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"BLtouch    |    BDsensor-m\n5V       --\x3e     5V\nGND      --\x3e     GND\nS        --\x3e     CLK/SCL    (Input)\nGND      --\x3e     GND\nZmin     --\x3e     SDA    (Input/Output) \n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Since some pins in the motherboard connector may not be directly connected to the MCU's GPIOs (for example, they may have filtering capacitors or be isolated by MOSFETs, diodes, or optocouplers, but they can also be used if they are isolated by resistors or resistor pull-ups/pull-downs), they cannot be used with ",(0,r.jsx)(n.code,{children:"BDsensor-m"}),". And the firmware will report a connection error. For example"]}),"\n",(0,r.jsx)(n.li,{children:"The connectors for fans and heaters are isolated by MOSFETs,"}),"\n",(0,r.jsx)(n.li,{children:"The connectors for temperature thermistors and endstops/probes in some circuit boards are usually connected to GND through filtering capacitors,"}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["As shown in the figure below, install the BD sensor near the hot end. ",(0,r.jsx)(n.a,{href:"https://www.thingiverse.com/thing:6098131",children:"STL of mount"}),",  ",(0,r.jsx)(n.a,{href:"https://discord.com/channels/829828765512106054/1163237892957671424",children:"STL_mount_VzBot_Goliath short"})]}),"\n",(0,r.jsx)(s,{image:t(1695).Z,size:"100%",align:"left"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"install-the-patch-to-the-klipper-firmware",children:"Install the patch to the klipper firmware"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Do not do anything not mentioned in the tutorial"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Discard previously modified klipper files and update klipper"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd\ncd ~/klipper\ngit checkout .\ngit pull\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Execute the following git command in the user directory to clone the latest code of BD sensor"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd && git clone https://github.com/markniu/Bed_Distance_sensor.git\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Then execute the following command to install"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd  ~/Bed_Distance_sensor/klipper/\n./install_BDsensor.sh\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"compile-firmware-here-if-prompted-that-the-firmware-of-the-upper-and-lower-computers-is-inconsistent-compile-a-new-klipper-firmware",children:["Compile firmware here ",(0,r.jsx)(n.code,{children:"if prompted that the firmware of the upper and lower computers is inconsistent"}),", compile a new klipper firmware"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Find your own firmware compilation tutorial to compile and flash the firmware"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Compile firmware"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd ~/klipper/  # go to klipper directory\nmake menuconfig  # enter klipper compilation interface command\nmake clean  # clean command\nmake   # compile command\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Burn the firmware to the motherboard connected to the BD sensor"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"if-your-printer-is-running-moonraker-add-the-following-part-to-moonrakerconf-and-then-you-can-update-bdsensor-by-clicking-once-through-the-web-page-or-klipperscreen",children:"If your printer is running Moonraker, add the following part to moonraker.conf, and then you can update BDsensor by clicking once through the web page or klipperscreen."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"[update_manager BDsensor]\ntype: git_repo\nprimary_branch: new\nchannel: dev\npath: ~/Bed_Distance_sensor\norigin: https://github.com/markniu/Bed_Distance_sensor.git\ninstall_script: ./klipper/install_BDsensor.sh\nis_system_service: False\nmanaged_services: klipper\ninfo_tags:\ndesc=Bed Distance Sensor\n"})}),"\n",(0,r.jsx)(n.h2,{id:"edit-printercfg",children:"Edit printer.cfg"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Copy this part to your ",(0,r.jsx)(n.strong,{children:"printer.cfg"})," and edit ",(0,r.jsx)(n.code,{children:"[BDsensor]"})," ",(0,r.jsx)(n.code,{children:"sda_pin"}),"  ",(0,r.jsx)(n.code,{children:"scl_pin"}),", and don't forget to disable other probe parts, such as ",(0,r.jsx)(n.strong,{children:"BLtouch"}),". You can connect the BD sensor on the motherboard or the CAN module of the tool head."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Change ",(0,r.jsx)(n.code,{children:"speed"})," to 0.8 in ",(0,r.jsx)(n.code,{children:"[BDsensor]"}),". This is only applicable to z tilt and PROBE_ACCURACY commands. The smaller the value, the higher the accuracy during probing, because the MCU does not read the BD sensor in the main loop in real-time like a normal stopper when homing. ",(0,r.jsx)(n.code,{children:"[BDsensor]"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["To use the BD sensor as a limit switch when the Z-axis homes, change ",(0,r.jsx)(n.code,{children:"endstop_pin"})," in ",(0,r.jsx)(n.code,{children:"[stepper_z]"})," to ",(0,r.jsx)(n.code,{children:"endstop_pin: probe:z_virtual_endstop"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Make sure there is ",(0,r.jsx)(n.code,{children:"[safe_z_home]"})," in ",(0,r.jsx)(n.strong,{children:"printer.cfg"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Change the value in ",(0,r.jsx)(n.code,{children:"[bed_mesh]"})," and ",(0,r.jsx)(n.code,{children:"[z_tilt]"})," or ",(0,r.jsx)(n.code,{children:"[quad_gantry_level]"})," to 1 (recommended 0.7-1.0mm). The default value in klipper is 5mm, otherwise it is easy to exceed the sensor range."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Nozzle height is only suitable for setting in ",(0,r.jsx)(n.code,{children:"z_adjust:"}),", positive numbers are close to the hot bed, negative numbers are away from the hot bed, other settings for adjusting nozzle height will have bugs"]})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["To enable fast bed scanning, delete the # in front of ",(0,r.jsx)(n.code,{children:"no_stop_probe:true"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Here is a configuration example."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cfg",children:"[BDsensor] \nscl_pin:PC6  # Servo signal port\nsda_pin:PC3  # Limit signal port\ndelay: 20 # 20us per pulse, this value should be >=20 but must be below 50\nz_offset:0 # this `z_offset` must be set to 0. \nz_adjust:0.0 # z axis adjustment, replace the z_offset function. within -0.3 to 0.3mm\nx_offset: -34\ny_offset: 0\n#no_stop_probe:true # enable this for fast probe, the toolhead will not stop at the probe point.\nposition_endstop: 0.8 # the Z axis will stop at this position (mm) while homing z, recommend value is 0.4~1.0\n#speed:0.8 # this speed only works for the z tilt and PROBE_ACCURACY command.\n\n[stepper_z]\nendstop_pin: probe:z_virtual_endstop \n#position_endstop: 0.5\nhoming_speed: 5\nsecond_homing_speed: 0.8\n\n[bed_mesh]\nspeed: 200\nhorizontal_move_z:1\nalgorithm: bicubic\n\n[quad_gantry_level]\nhorizontal_move_z:1\n\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"after-installation-check-by-sending-the-following-gcode-commands",children:"After installation, check by sending the following gcode commands"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"M102   S-1     # Read sensor information\nM102   S-2     # Read a distance value\n"})}),"\n",(0,r.jsx)(n.h2,{id:"check-connection",children:"Check connection"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Send ",(0,r.jsx)(n.code,{children:"M102 S-1"})," through the ",(0,r.jsx)(n.strong,{children:"console"}),", this is an example of the returned message, if it returns blank or other strings please check the connection and wire order"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"Send: M102 S-1\nRecv: V1.0 pandapi3d.com\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"calibration",children:"Calibration"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Clean the nozzle, then move the Z-axis through the console until the nozzle just touches the bed plate (BDsensor-m will use this position as the zero position, so there is no need for ",(0,r.jsx)(n.code,{children:"z_offset"}),", this is why the value in [BDsensor-m] part is 0)"]}),"\n",(0,r.jsxs)(n.li,{children:["Send the gcode command ",(0,r.jsx)(n.code,{children:"M102 S-6"})," through the ",(0,r.jsx)(n.strong,{children:"console"}),", the printer will move the Z-axis slowly upward by 0.1mm each time until it reaches 4mm. Do not run M102 S-6 before installing the sensor, nor turn off the printer power during calibration, otherwise the old calibration data will be deleted. If this happens, just calibrate again"]}),"\n",(0,r.jsxs)(n.li,{children:["Afterwards, you can check if the BD sensor has been successfully calibrated through ",(0,r.jsx)(n.code,{children:"M102 S-5"}),", which will return the original calibration data stored in the BD sensor."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Notes"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"The best speed for homing the Z-axis is 5"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"If the first original calibration data returned by M102 S-5 is greater than 400, it means the sensor is installed too high and needs to be reinstalled closer to the bed, the recommended value for the first data is 100. Also make sure that the second data value is more than 10 greater than the first data"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"FAQ: What does it mean if the calibration data starts with 1, the second value is 9, and the third value is 24?"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"This means that the resolution between 0-0.1mm is only 9, while the resolution between 0.1-0.2mm is 15. Therefore, it is recommended to recalibrate to make the first resolution 0-0.1mm greater than 10."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Do not forget to adjust the Z-axis height after running G28 or for these commands ",(0,r.jsx)(n.code,{children:"Z_tilt"})," and ",(0,r.jsx)(n.code,{children:"quad_gantry_level"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["The part names must be correctly capitalized and lowercased, otherwise klipper will report ",(0,r.jsx)(n.code,{children:"Unknown pin chip name 'probe'"})]}),"\n"]}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},1695:function(e,n,t){t.d(n,{Z:function(){return s}});let s=t.p+"assets/images/jxcs_webp-e90fb83e26a5605607e720e487bc6f3a.webp"},50065:function(e,n,t){t.d(n,{Z:function(){return l},a:function(){return o}});var s=t(67294);let r={},i=s.createContext(r);function o(e){let n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);